var CouponDict=function(){};CouponDict.prototype={bindEvent:function(){function c(i){if($(i.target).closest(".coupon_pop").size()!=0||$(i.target).closest(".coupon_dialog_jf").size()!=0||($(i.target).text()=="提交")||($(i.target).text()=="确认")){return}$(".coupon_pop").slideUp();$(".coupon_choose_pointer").removeClass("upcoupon")}function h(i){if(false===NAMESPACE_CART.isLogin){return showMsgBox("","","",cart.mergeLogin,"","","shopping")}else{f(i)}}var g;function f(j){g=j.target;if($(j.target).parentsUntil("tr").find(".coupon_pop").is(":hidden")){var i=$(j.target).parent().parent().find("li[data-serial-num]");a(i,function(){if($("#couponjs_id").length!=1){var k=document.createElement("script");k.type="text/javascript";k.src=NAMESPACE_CART.couponJsUrl;k.charset="GBK";k.id="couponjs_id";$("head")[0].appendChild(k)}},function(){$(".coupon_pop").hide();$(j.target).parentsUntil("tr").find(".coupon_pop").slideDown();$(j.target).addClass("upcoupon")})}else{$(".coupon_pop").slideUp();$(".coupon_choose_pointer").removeClass("upcoupon")}}function b(){var i=$(g).parent().parent().find("li[data-serial-num]");a(i);return true}function a(n,l,m){var i="",k="";for(var j=0;j<n.length;j++){i+=$(n[j]).attr("data-serial-num");k+=$(n[j]).attr("data-everyone-rec-num");if(j!=(n.length-1)){i+=",";k+=","}}if(l!=undefined){l()}$.ajax({url:"check_coupon_usable",dataType:"json",data:{serialNum:i,usableNum:k},success:function(r){if(r.code==0){if((r.body!=null)&&r.body.length!=0){for(var t in r.body){var q=t;var p=r.body[t];var o=$('.coupon_pop li[data-serial-num="'+q+'"]');if(o.length!=0){if(p==true){var s=o.find("a.btn");if(s.length!=0){s.removeClass("unable")}}else{var s=o.find("a.btn");if(s.length!=0){s.addClass("unable");s.text("已领取");$(s).unbind("click")}}}}}}if(m!=undefined){m()}}})}function d(i){if($(i.target).parent().parent().find(".coupon_show").is(":hidden")){$(i.target).parent().parent().find(".coupon_show").slideDown();$(i.target).parent().find("em").each(function(){$(this).addClass("upem")})}else{$(i.target).parent().parent().find(".coupon_show").slideUp();$(i.target).parent().find("em").each(function(){$(this).removeClass("upem")})}}function e(w){var o=$(w.target).parent().find(".coupon_show_list_ul").attr("data-current-start-num");var z=$(w.target).parent().find("#shopIdStrInput").val().split(",");var s=$(w.target).parent().find("#itemIdStrInput").val().split(",");var q=$(w.target).parent().find("#prodImgStrInput").val().split(",");var k=$(w.target).parent().find("#prodPriceStrInput").val().split(",");var j=$(w.target).parent().find("#prodCountStrInput").val().split(",");var t=$(w.target).parent().find("#prodCheckedStrInput").val().split(",");var v=$(w.target).parent().find("#groupInfoStrInput").val().split(",");var p=$(w.target).parent().find("#currentGroupInfoStrInput").val();var r=$(w.target).parent().find("#couponSerialNumInput").val();var i=s.length;var y=Math.ceil(parseInt(i)/5);$(w.target).parent().find("li").html("");$(w.target).parent().find("li").hide();if($(w.target).attr("class").indexOf("right")>0){if(parseInt(o)==parseInt(y)){o=1}else{o=parseInt(o)+1}}else{if(parseInt(o)==1){o=y}else{o=parseInt(o)-1}}$(w.target).parent().find(".coupon_show_list_ul").attr("data-current-start-num",o);var x=0;for(var l=1;l<=5;l++){var m=(parseInt(o)-1)*5+parseInt(l);if(parseInt(m)>parseInt(i)){break}x++;var n="<span class='item'><img src='"+q[m-1]+"'>";n+="<a href='javascript:void(0)' data-item='"+s[m-1]+"' ";n+="data-shopId='"+z[m-1]+"' ";n+="data-groupinfo='"+v[m-1]+"' ";n+="data-current_groupinfo='"+p+"' ";n+="data-coupon_serial_num='"+r+"' ";if(t[m-1]=="true"){n+=" class='fn-product-check-for-coupon checknow check_on'>选中</a>"}else{n+=" class='fn-product-check-for-coupon checknow'>未选中</a>"}n+="</span>";if(v[m-1]!=null&&v[m-1].indexOf("promoId_")>-1){n+="<div class='tag_line'><span class='tag'>跨店铺促销</span></div>"}n+="<span>¥"+k[m-1]+"</span>";n+="<span>x"+j[m-1]+"</span>";$(w.target).parent().find("#img_seq_"+x).html(n)}var u=0;$($(w.target).parent().find("li")).each(function(){u++;if(parseInt(x)>=parseInt(u)){$(this).show()}else{return false}})}$(document).live("click",c);$(".coupon_choose_pointer").live("click",h);$(document).live("click",function(j){var i=$(j.target).find("#shop_gift_list");i.each(function(){if($(this).is(":visible")){$(this).slideUp()}})});$(".choose_shop_gift").live("click",function(i){var j=$(i.target).parent().parent().find("#shop_gift_list");if(j.is(":hidden")){j.slideDown()}else{j.slideUp()}});$(".show_prodimg_label").live("click",d);$(".show_prodimg_em").live("click",d);$(".coupon_arrow").live("click",e);$(".coupon_dialog_jf .header .close").live("mouseup",b);$(".coupon_dialog_jf .content .button[onclick]").live("mouseup",b)},getCouponUsableStatus:function(){var d=$("li[data-serial-num]");var a="",c="";for(var b=0;b<d.length;b++){a+=$(d[b]).attr("data-serial-num");c+=$(d[b]).attr("data-everyone-rec-num");if(b!=(d.length-1)){a+=",";c+=","}}$.ajax({url:"check_coupon_usable",dataType:"json",data:{serialNum:a,usableNum:c},success:function(h){if(h.code==0){if((h.body!=null)&&h.body.length!=0){for(var j in h.body){var g=j;var f=h.body[j];var e=$('.coupon_pop li[data-serial-num="'+g+'"]');if(e.length!=0){if(f!=true){var i=e.find('a[class="btn" ]');if(i.length!=0){i.addClass("unable");i.text("已领取")}}}}}$(".coupon_title_td").css("visibility","visible")}}})},fetchCouponList:function(c){couponDict.reqKey=Math.random();var d=$("tbody[data-productid]");if(d==null||d.length==0){return}var a="";for(var b=0;b<d.length;b++){a=a+$(d[b]).data("productid")+","}if(c){$.ajax({url:"list_coupons",dataType:"json",data:{productIds:a,reqKey:couponDict.reqKey},success:function(e){if(e.code==0&&e.body.reqKey==couponDict.reqKey){var f=e.body.list;couponDict.couponList=e.body.list;couponDict.renderCoupon(f)}else{couponDict.couponList=[]}},error:function(){couponDict.couponList=[]}})}else{couponDict.renderCoupon(couponDict.couponList)}},renderCoupon:function(p){if(p.length==0){return}var a=$(".shopping_list");for(var u=0;u<a.length;u++){var t="";var b=$(a[u]);var v=[];var x={};var y=b.find("tbody[data-offline!=true]");if(y!=null&&y.length>0){for(var r=0;r<y.length;r++){if($(y[r]).find(".oos").length!=0){continue}var e={};e.productId=$(y[r]).data("productid");if(utils.isEbook(e)){continue}e.imgUrl=$(y[r]).find(".row_img a img").attr("src");v.push(e)}if(v.length==0){continue}var d=0;for(var r=0;r<p.length;r++){for(var g=0;g<v.length;g++){var o=p[r];if($.inArray(v[g].productId,o.productIdSet)!=-1){if(x[o.couponModel.activitySerialNum]){var m=x[o.couponModel.activitySerialNum];m.productIdSet.push(v[g])}else{var q={};$.extend(true,q,o);q.productIdSet=[];q.productIdSet.push(v[g]);x[o.couponModel.activitySerialNum]=q;d++}}}}if(d>0){var k=0;t+="<div class='coupon_pop'>";t+="<ul>";for(var l in x){var n=x[l];k=k+1;t+="<li data-serial-num='"+n.couponModel.activitySerialNum+"' data-everyone-rec-num='"+n.couponModel.activityEveryoneRecNum+"'>";t+="<div class='coupon_num'>¥"+n.couponModel.couponValue+"</div>";t+="<p>";if(n.couponModel.couponMinUseValue>0){t+="满"+n.couponModel.couponMinUseValue+"元可用"}else{t+="无门槛现金券"}t+="<span class='gray'>"+n.couponModel.couponStartDate.substring(0,10)+"至"+n.couponModel.couponEndDate.substring(0,10)+"</span></p>";t+="<a class='show_prodimg'><label class='show_prodimg_label'>购物车内可用此券商品</label><em class='show_prodimg_em'></em></a>";var c="data-coupon-activity='"+n.couponModel.activitySerialNum+"|shoppingcart|||init-no-load'";if(n.couponModel.activityReceivedCrowd!=null&&n.couponModel.activityReceivedCrowd!=""){var w=n.couponModel.activityReceivedCrowd;if(w.indexOf("0")!=-1){t+="<a class='btn' "+c+">领取</a>"}else{if(w.indexOf("3")!=-1){t+="<a class='btn' "+c+">银卡VIP领取</a>"}else{if(w.indexOf("1")!=-1){t+="<a class='btn' "+c+">金卡VIP领取</a>"}else{if(w.indexOf("2")!=-1){t+="<a class='btn' "+c+">钻石VIP领取</a>"}else{t+="<a class='btn' "+c+">领取</a>"}}}}}else{t+="<a class='btn' "+c+">领取</a>"}t+="<div class='coupon_show'>";if(n.productIdSet.length<=5){t+="<a class='coupon_arrow' style='display:none;'></a><a class='coupon_arrow right' style='display:none;'></a>"}else{t+="<a class='coupon_arrow'></a><a class='coupon_arrow right'></a>"}t+="<div class='coupon_show_list'><ul class='coupon_show_list_ul' data-current-start-num='1'>";var f=0;var s="";$.each(n.productIdSet,function(i,j){f++;if(f<=5){t+="<li id='img_seq_"+f+"'><img src=\""+j.imgUrl+'"></li>'}if(n.productIdSet.length>5){s+=j.imgUrl+","}});t+="</ul>";if(n.productIdSet.length>5){s=s.substring(0,s.length-1);t+="<input type='hidde' value='"+s+"' id='prodIdStrInput' />"}t+="</div>";t+="</li>"}t+="</ul>";t+="</div>"}}if(t!=""){var h=b.parent().find("#coupon_pop_container");h.append(t);h.parent().show("slow")}}couponDict.bindEvent()}};var couponDict=new CouponDict();window.couponDict=couponDict;