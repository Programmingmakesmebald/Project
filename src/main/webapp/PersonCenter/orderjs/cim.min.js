var CIMPHost="http://cim.dangdang.com",CIMPHost="http://static.dangdang.com";!function(root,factory){"function"==typeof define&&define.amd?define("im",["jquery"],factory):"object"==typeof exports?module.exports=factory(require("jquery")):root.CIM=factory(root.jQuery)}(this,function($){function CIM({user:user={sid:""},cimPath:cimPath=""}={}){this.cimPath=cimPath,this.impSrc=cimPath+"/imp/index.html",this.imi="",this.imn="",this.IMIStatus="",this.IMSStatus=0,this.msg2ImpQueue=[],this.entryQueue=[],this.debug=!0,this.debug=!1,this.log=this.debug?console.log.bind(this,"%cCIM::","color:#2e2"):()=>{},this.init()}return CIM.prototype={construtor:CIM,init(){this.renderHtml(),this.imc=document.getElementById("cimc"),this.imi=document.getElementById("cimi"),this.imn=document.getElementById("cimn"),this.ime=document.getElementById("cime"),this.IMETimer=null,this.bindEvent()},renderHtml(){var str=`\n                <link rel="stylesheet" href="${this.cimPath+"/public/css/cim.css"}" >\n                <div id="cimc" style="display:none;">\n                    <div class="imc-main">\n                        \x3c!-- <div class="imc-mian-loading"></div>   --\x3e\n                        <iframe id="cimi" src="${this.impSrc}" width="100%" height="100%" style=""></iframe>\n                    </div>\n                </div>\n                <div id="cime" style="display:nonex;">\n                    \x3c!-- 用户未登录！请登录后重试 --\x3e\n                    \x3c!-- 正在连接客服 ... ... --\x3e\n                    \x3c!-- 未连接到客服!   --\x3e\n                </div> \n                <div id="cimn" class="" style="display:none;">\n                    <img src="${this.cimPath}/public/images/kefu.png"> 联系客服\n                </div>\n            `;document.body.insertAdjacentHTML("beforeend",str)},bindEvent(){this.imn.addEventListener("click",()=>{this.openIMC()}),this.imi.onload=()=>{this.IMIStatus="loaded",this.postMsg2IMP({type:"onloaded"}),this.msg2ImpQueue.length>0&&(this.msg2ImpQueue.forEach(msg=>{this.postMsg2IMP(msg)}),this.msg2ImpQueue=[])}},openIMC(){this.imn.style.display="none",this.imc.style.display="block",this.ime.style.display="none",this.postMsg2IMP({type:"IMCDisplay",status:"normal"}),clearTimeout(this.IMETime),this.IMETimer=null},openIMN({shopName:shopName="联系客服",shopPortrait:shopPortrait=this.cimPath+"/public/images/kefu.png"}={},isNewMsg=!1){this.imn.className=isNewMsg?"newMsg":"",this.imn.innerHTML=`<span></span><img src=${shopPortrait}>${shopName}`,this.imc.style.display="none",this.imn.style.display="block"},openIME(text="",timeout=1e4){this.ime.innerHTML=text,this.ime.style.display="block",this.IMETimer=setTimeout(()=>{this.ime.style.display="none"},timeout)},closeIMC(){this.imc.style.display="none",this.ime.style.display="none",this.imn.style.display="none"},postMsg2IMP({type:type="",data:data={}}={}){"loaded"==this.IMIStatus?"loaded"==this.IMIStatus&&this.imi.contentWindow.postMessage({type:type,data:data},this.impSrc):this.msg2ImpQueue.push({type:type,data:data})},onIMPMsg(msg){this.log("cim onMsg msg",msg);var type=msg.type,data=msg.data;switch(type){case"IMSStatus":this.IMSStatus=data,2==data&&(this.openIME("正在分配客服,请耐心等候...",12e3),this.entryQueue.map(entry=>{this.postMsg2IMP({type:"entry",data:entry})}),this.entryQueue=[]);break;case"newMsg":this.openIMN(data,!0);break;case"IMNDisplay":this.openIMN(data);break;case"IMCClose":this.closeIMC();break;case"roomReady":this.openIMC();break;case"info":this.openIME(data);break;case"channelFold":"fold"==data&&(this.imc.style.width="880px"),"unfold"==data&&(this.imc.style.width="1130px")}}},CIM}),function(window,document,$,CIM,showMsgBox,CIMPHost){showMsgBox||(showMsgBox=function(Id,parameters,TransferPath,callbackfunc,callbackid,callbackparameters){callbackfunc(callbackparameters)});var cimPath=CIMPHost+"",cimPath,cim=new CIM({cimPath:CIMPHost+"/cim"});document.body.addEventListener("click",function(e){var target=e.target,clsName;if(!(target.className||"").includes("cim_entry"))return;const shopId=target.dataset.shopid||"",ddShopId=target.dataset.ddshopid||"0";if(shopId>0)return;e.stopPropagation(),target.onclick=null;const sourcePage=target.dataset.sourcepage||"",sourceContent=target.dataset.orderid||target.dataset.productId||"";var entry={shopId:shopId,ddShopId:ddShopId,sourcePage:sourcePage,sourceContent:sourceContent};if(cim.openIME("正在联系客服,请稍候...",12e3),2!==cim.IMSStatus){var sid=getCookie("sessionID");sid||cim.openIME("请登录后重试。"),cim.postMsg2IMP({type:"sessionId",data:sid}),cim.entryQueue.push(entry)}2==cim.IMSStatus&&cim.postMsg2IMP({type:"entry",data:entry})},!0);var callCIM=async function(target={}){};function getCookie(key){if(key){key=key.trim();var res="",res;return null!=(res=document.cookie.match(new RegExp("(^| )"+key+"=([^;]*)(;|$)")))?decodeURIComponent(res[2]):""}}window.addEventListener("message",event=>{event.origin.includes(CIMPHost)&&cim.onIMPMsg(event.data)},!1)}(window,document,window.jQuery,window.CIM,window.showMsgBox,CIMPHost);